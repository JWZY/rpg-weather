<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Preview Generator - RPG Weather Widget</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background: #000;
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', system-ui, sans-serif;
      -webkit-font-smoothing: antialiased;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 40px;
      gap: 20px;
    }

    .instructions {
      color: rgba(255,255,255,0.6);
      font-size: 13px;
      text-align: center;
      max-width: 600px;
    }

    .preview-frame {
      width: 1200px;
      height: 630px;
      position: relative;
      overflow: hidden;
      /* NO border radius - clean edges for screenshot */
    }

    /* Biome color schemes */
    .biome-forest { --widget-bg: linear-gradient(145deg, #1a4d2e 0%, #0d2618 100%); --accent: #4ade80; }
    .biome-desert { --widget-bg: linear-gradient(145deg, #c4a35a 0%, #8b6914 100%); --accent: #fbbf24; }
    .biome-tundra { --widget-bg: linear-gradient(145deg, #64b5d9 0%, #2d5a6b 100%); --accent: #93c5fd; }
    .biome-swamp { --widget-bg: linear-gradient(145deg, #4a5d23 0%, #2d3a14 100%); --accent: #84cc16; }
    .biome-mountains { --widget-bg: linear-gradient(145deg, #64748b 0%, #334155 100%); --accent: #94a3b8; }
    .biome-plains { --widget-bg: linear-gradient(145deg, #84a63c 0%, #4d6b1a 100%); --accent: #bef264; }
    .biome-coast { --widget-bg: linear-gradient(145deg, #0891b2 0%, #164e63 100%); --accent: #22d3ee; }
    .biome-jungle { --widget-bg: linear-gradient(145deg, #166534 0%, #052e16 100%); --accent: #22c55e; }
    .biome-volcanic { --widget-bg: linear-gradient(145deg, #7f1d1d 0%, #1c0a0a 100%); --accent: #f97316; }
    .biome-arctic { --widget-bg: linear-gradient(145deg, #e0f2fe 0%, #7dd3fc 100%); --accent: #38bdf8; --text-primary: #0c4a6e; --text-secondary: rgba(12, 74, 110, 0.7); --text-tertiary: rgba(12, 74, 110, 0.5); }
    .biome-savanna { --widget-bg: linear-gradient(145deg, #d4a574 0%, #92631a 100%); --accent: #f59e0b; }
    .biome-cavern { --widget-bg: linear-gradient(145deg, #4c1d95 0%, #1e1b4b 100%); --accent: #a78bfa; }

    .preview-frame {
      --text-primary: #ffffff;
      --text-secondary: rgba(255, 255, 255, 0.7);
      --text-tertiary: rgba(255, 255, 255, 0.5);
      background: var(--widget-bg);
      display: flex;
      flex-direction: column;
    }

    /* Time overlays */
    .time-morning { --time-overlay: rgba(255, 236, 179, 0.1); }
    .time-afternoon { --time-overlay: rgba(255, 213, 79, 0.12); }
    .time-evening { --time-overlay: rgba(66, 66, 99, 0.3); }
    .time-night { --time-overlay: rgba(15, 23, 42, 0.45); }
    .biome-cavern { --time-overlay: rgba(15, 23, 42, 0.45); }

    .preview-frame::before {
      content: '';
      position: absolute;
      inset: 0;
      background: var(--time-overlay, transparent);
      pointer-events: none;
      z-index: 0;
    }

    .weather-particles {
      position: absolute;
      inset: 0;
      overflow: hidden;
      pointer-events: none;
      z-index: 1;
    }

    /* Header */
    .widget-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 40px 50px;
      position: relative;
      z-index: 2;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .time-icon {
      width: 42px;
      height: 42px;
      color: var(--accent);
    }

    .biome-savanna .time-icon {
      color: rgba(255, 255, 255, 0.85);
    }

    .widget-title {
      font-size: 32px;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.03em;
    }

    .biome-badge {
      display: flex;
      align-items: center;
      gap: 12px;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(8px);
      border-radius: 16px;
      padding: 14px 24px;
      font-size: 32px;
      font-weight: 500;
      color: var(--text-secondary);
    }

    .biome-icon {
      width: 36px;
      height: 36px;
      opacity: 0.8;
    }

    /* Visual area */
    .visual-area {
      flex: 1;
      position: relative;
      z-index: 1;
    }

    /* Bottom */
    .widget-bottom {
      display: flex;
      justify-content: space-between;
      padding: 40px 50px;
      position: relative;
      z-index: 2;
    }

    .weather-name {
      font-size: 48px;
      font-weight: 500;
      color: var(--text-primary);
      margin-bottom: 8px;
    }

    .weather-detail {
      font-size: 28px;
      color: var(--text-tertiary);
    }

    .bottom-right {
      text-align: right;
    }

    .temp-feel {
      font-size: 40px;
      font-weight: 500;
      color: var(--text-primary);
      margin-bottom: 8px;
    }

    .wind-speed {
      font-size: 28px;
      color: var(--text-tertiary);
    }

    /* Particle styles - base styles, sizes set dynamically with SCALE */
    .particle { position: absolute; pointer-events: none; }

    .particle.rain {
      width: 1px;
      background: linear-gradient(to bottom, transparent, rgba(240, 245, 255, 0.6));
      border-radius: 0.5px;
    }

    .particle.snow {
      background: rgba(255, 255, 255, 0.9);
      border-radius: 50%;
    }

    .particle.fog {
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
      border-radius: 1px;
    }

    .particle.sand {
      background: rgba(210, 180, 140, 0.7);
      border-radius: 1px;
    }

    .particle.ash {
      background: rgba(128, 128, 128, 0.6);
      border-radius: 50%;
    }

    .particle.spark {
      background: rgba(255, 200, 100, 0.8);
      border-radius: 50%;
      box-shadow: 0 0 4px rgba(255, 150, 50, 0.6);
    }

    .particle.ray {
      background: linear-gradient(to bottom,
        rgba(255, 250, 200, 0.5),
        rgba(255, 240, 150, 0.3) 30%,
        rgba(255, 240, 150, 0.1) 60%,
        transparent 85%
      );
      border-radius: 50% 50% 50% 50% / 10% 10% 90% 90%;
      filter: blur(2px);
      box-shadow: 0 0 20px rgba(255, 240, 150, 0.3);
    }

    .particle.sundust {
      border-radius: 50%;
      background: rgba(255, 255, 240, 0.6);
      box-shadow: 0 0 2px rgba(255, 250, 200, 0.4);
    }

    .particle.star {
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.9);
      box-shadow: 0 0 4px rgba(255, 255, 255, 0.8), 0 0 8px rgba(200, 220, 255, 0.4);
    }

    .particle.cloud {
      background: radial-gradient(ellipse at center, rgba(255, 255, 255, 0.15) 0%, rgba(255, 255, 255, 0.08) 40%, transparent 70%);
      border-radius: 50%;
      filter: blur(8px);
    }

    .particle.splash {
      background: rgba(240, 245, 255, 0.5);
      border-radius: 50%;
    }

    .particle.snowflake {
      background: radial-gradient(circle, rgba(255,255,255,0.95) 0%, rgba(255,255,255,0.3) 70%, transparent 100%);
      border-radius: 50%;
      box-shadow: 0 0 3px rgba(255, 255, 255, 0.5);
    }

    .particle.fogbank {
      background: linear-gradient(90deg,
        transparent,
        rgba(255, 255, 255, 0.15) 20%,
        rgba(255, 255, 255, 0.25) 50%,
        rgba(255, 255, 255, 0.15) 80%,
        transparent
      );
      border-radius: 50%;
      filter: blur(3px);
    }

    .particle.ember {
      background: radial-gradient(circle, rgba(255, 200, 50, 1) 0%, rgba(255, 100, 0, 0.8) 50%, transparent 100%);
      border-radius: 50%;
      box-shadow: 0 0 6px rgba(255, 150, 50, 0.8), 0 0 12px rgba(255, 100, 0, 0.4);
    }

    .particle.drip {
      background: linear-gradient(to bottom, transparent, rgba(100, 150, 200, 0.6));
      border-radius: 0 0 2px 2px;
    }

    /* Lightning flash */
    .lightning-flash {
      position: absolute;
      inset: 0;
      background: rgba(255, 255, 255, 0.8);
      opacity: 0;
      pointer-events: none;
      z-index: 3;
    }

    .lightning-flash.active {
      animation: flash 0.15s ease-out;
    }

    @keyframes flash {
      0% { opacity: 0.8; }
      100% { opacity: 0; }
    }

    /* Controls */
    .controls {
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
      justify-content: center;
    }

    .controls select, .controls button {
      padding: 10px 16px;
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 8px;
      color: white;
      font-size: 14px;
      cursor: pointer;
    }

    .controls select option {
      background: #1a1a2e;
    }

    .controls button:hover {
      background: rgba(255,255,255,0.2);
    }

    .size-label {
      color: rgba(255,255,255,0.4);
      font-size: 12px;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <div class="instructions">
    Adjust biome, weather, and time below. Then take a screenshot of the 1200x630 frame.<br>
    On Mac: <strong>Cmd+Shift+4</strong>, then drag to select the frame exactly.
  </div>

  <div class="preview-frame biome-forest time-morning" id="previewFrame">
    <div class="weather-particles" id="particles"></div>
    <div class="lightning-flash" id="lightning"></div>

    <div class="widget-header">
      <div class="header-left">
        <svg class="time-icon" id="timeIcon" viewBox="0 0 24 24"></svg>
        <span class="widget-title" id="timeLabel">MORNING</span>
      </div>
      <div class="biome-badge">
        <svg class="biome-icon" id="biomeIcon" viewBox="0 0 24 24"></svg>
        <span id="biomeLabel">Forest</span>
      </div>
    </div>

    <div class="visual-area"></div>

    <div class="widget-bottom">
      <div class="bottom-left">
        <div class="weather-name" id="weatherName">Clear</div>
        <div class="weather-detail" id="weatherDetail">Calm conditions</div>
      </div>
      <div class="bottom-right">
        <div class="temp-feel" id="tempFeel">Mild</div>
        <div class="wind-speed" id="windSpeed">Calm</div>
      </div>
    </div>
  </div>

  <div class="size-label">1200 Ã— 630 pixels</div>

  <div class="controls">
    <select id="biomeSelect">
      <option value="forest">Forest</option>
      <option value="desert">Desert</option>
      <option value="tundra">Tundra</option>
      <option value="swamp">Swamp</option>
      <option value="mountains">Mountains</option>
      <option value="plains">Plains</option>
      <option value="coast">Coast</option>
      <option value="jungle">Jungle</option>
      <option value="volcanic">Volcanic</option>
      <option value="arctic">Arctic</option>
      <option value="savanna">Savanna</option>
      <option value="cavern">Cavern</option>
    </select>

    <select id="weatherSelect">
      <option value="clear">Clear</option>
      <option value="cloudy">Cloudy</option>
      <option value="rain">Rain</option>
      <option value="fog">Fog</option>
      <option value="storm">Storm</option>
    </select>

    <select id="timeSelect">
      <option value="morning">Morning</option>
      <option value="afternoon">Afternoon</option>
      <option value="evening">Evening</option>
      <option value="night">Night</option>
    </select>
  </div>

  <script>
    // Frame dimensions (scaled up from 329x155)
    const WIDTH = 1200;
    const HEIGHT = 630;
    const SCALE = WIDTH / 329; // ~3.65x

    const BIOME_WEATHER = {
      forest: ['clear', 'cloudy', 'rain', 'fog', 'storm'],
      desert: ['clear', 'windy', 'hot', 'sandstorm'],
      tundra: ['clear', 'cloudy', 'snow', 'blizzard'],
      swamp: ['cloudy', 'foggy', 'rain', 'humid'],
      mountains: ['clear', 'windy', 'snow', 'storm', 'fog'],
      plains: ['clear', 'cloudy', 'rain', 'windy', 'storm'],
      coast: ['clear', 'cloudy', 'rain', 'fog', 'storm'],
      jungle: ['humid', 'rain', 'downpour', 'misty'],
      volcanic: ['ash', 'smoke', 'hot', 'fiery'],
      arctic: ['blizzard', 'snow', 'clear', 'ice_storm'],
      savanna: ['clear', 'dry', 'windy', 'dust'],
      cavern: ['damp', 'dripping', 'humid']
    };

    const WEATHER_INFO = {
      clear: { name: 'Clear', detail: 'Calm conditions', particles: 'rays' },
      cloudy: { name: 'Cloudy', detail: 'Overcast skies', particles: 'clouds' },
      rain: { name: 'Rain', detail: 'Steady rainfall', particles: 'rain' },
      fog: { name: 'Fog', detail: 'Low visibility', particles: 'fog' },
      storm: { name: 'Storm', detail: 'Thunder and lightning', particles: 'storm' },
      windy: { name: 'Windy', detail: 'Strong gusts', particles: 'wind' },
      hot: { name: 'Hot', detail: 'Scorching heat', particles: 'heat' },
      sandstorm: { name: 'Sandstorm', detail: 'Blowing sand', particles: 'sand' },
      snow: { name: 'Snow', detail: 'Light snowfall', particles: 'snow' },
      blizzard: { name: 'Blizzard', detail: 'Heavy snow and wind', particles: 'blizzard' },
      foggy: { name: 'Foggy', detail: 'Dense fog', particles: 'fog' },
      humid: { name: 'Humid', detail: 'Thick moisture', particles: 'mist' },
      downpour: { name: 'Downpour', detail: 'Heavy rain', particles: 'downpour' },
      misty: { name: 'Misty', detail: 'Light mist', particles: 'mist' },
      ash: { name: 'Ash', detail: 'Falling ash', particles: 'ash' },
      smoke: { name: 'Smoke', detail: 'Thick smoke', particles: 'smoke' },
      fiery: { name: 'Fiery', detail: 'Sparks flying', particles: 'sparks' },
      ice_storm: { name: 'Ice Storm', detail: 'Freezing rain', particles: 'ice' },
      dry: { name: 'Dry', detail: 'Arid conditions', particles: 'none' },
      dust: { name: 'Dust', detail: 'Dusty winds', particles: 'dust' },
      damp: { name: 'Damp', detail: 'Moisture dripping', particles: 'drip' },
      dripping: { name: 'Dripping', detail: 'Water dripping', particles: 'drip' }
    };

    const TIME_ICONS = {
      morning: '<circle cx="12" cy="12" r="4" fill="currentColor"/><path d="M12 2v2M12 20v2M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M2 12h2M20 12h2M4.93 19.07l1.41-1.41M17.66 6.34l1.41-1.41" stroke="currentColor" stroke-width="2"/>',
      afternoon: '<circle cx="12" cy="12" r="5" fill="currentColor"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2"/>',
      evening: '<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" fill="currentColor"/>',
      night: '<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" fill="currentColor"/><circle cx="18" cy="5" r="1" fill="currentColor"/><circle cx="15" cy="8" r="0.5" fill="currentColor"/><circle cx="20" cy="9" r="0.5" fill="currentColor"/>'
    };

    const BIOME_ICONS = {
      forest: { viewBox: '0 0 640 512', path: '<path d="M298.42 288h30.63c9.01 0 16.98-5 20.78-13.06 3.8-8.04 2.55-17.26-3.28-24.05L268.42 160h28.89c9.1 0 17.3-5.35 20.86-13.61 3.52-8.13 1.86-17.59-4.24-24.08L203.66 4.83c-6.03-6.45-17.28-6.45-23.32 0L70.06 122.31c-6.1 6.49-7.75 15.95-4.24 24.08C69.39 154.65 77.59 160 86.69 160h28.89l-78.14 90.91c-5.81 6.78-7.06 15.99-3.27 24.04C37.97 283 45.93 288 54.95 288h30.63L5.69 378.49c-6 6.79-7.36 16.09-3.56 24.26 3.75 8.05 12 13.25 21.01 13.25H160v24.45l-30.29 48.4c-5.32 10.64 2.42 23.16 14.31 23.16h95.96c11.89 0 19.63-12.52 14.31-23.16L224 440.45V416h136.87c9.01 0 17.26-5.2 21.01-13.25 3.8-8.17 2.44-17.47-3.56-24.26L298.42 288zm335.89 90.49L554.42 288h30.63c9.01 0 16.98-5 20.78-13.06 3.8-8.04 2.55-17.26-3.28-24.05L524.42 160h28.89c9.1 0 17.3-5.35 20.86-13.61 3.52-8.13 1.86-17.59-4.24-24.08L459.66 4.83c-6.03-6.45-17.28-6.45-23.32 0l-95.06 101.26c11.09 15.37 13.97 35.3 6.34 52.96-4 9.27-10.38 17.03-18.26 22.68l41.54 48.32c13.93 16.25 17.04 39.23 7.94 58.52-4.19 8.89-10.46 16.24-18.11 21.58l41.62 47.15c8.65 9.8 13.34 14.15 13.65 26.69v56.45l-30.29 48.4c-5.32 10.64 2.42 23.16 14.31 23.16h95.96c11.89 0 19.63-12.52 14.31-23.16L480 440.45V416h136.87c9.01 0 17.26-5.2 21.01-13.25 3.79-8.17 2.43-17.47-3.57-24.26z" fill="currentColor"/>' },
      desert: { viewBox: '0 0 512 512', path: '<path d="M464 224a48 48 0 0 0-48 48v64a16 16 0 0 1-16 16h-48V101.43c0-52-38.93-98.58-90.84-101.29A96 96 0 0 0 160 96v128h-48a16 16 0 0 1-16-16v-64a48 48 0 0 0-96 0v64a112 112 0 0 0 112 112h48v160a32 32 0 0 0 32 32h128a32 32 0 0 0 32-32v-32h48a112 112 0 0 0 112-112v-64a48 48 0 0 0-48-48zm-240-48a16 16 0 1 1 16-16 16 16 0 0 1-16 16zm64 224a16 16 0 1 1 16-16 16 16 0 0 1-16 16z" fill="currentColor"/>' },
      tundra: { viewBox: '0 0 640 512', path: '<path d="M608.1 256l27.9-16c3.8-2.2 5.1-7.1 2.9-10.9l-8-13.9c-2.2-3.8-7.1-5.1-10.9-2.9l-28 16.1V200c0-4.4-3.6-8-8-8h-16c-4.4 0-8 3.6-8 8v28.4l-28-16.1c-3.8-2.2-8.7-.9-10.9 2.9l-8 13.9c-2.2 3.8-.9 8.7 2.9 10.9l27.9 16-27.9 16c-3.8 2.2-5.1 7.1-2.9 10.9l8 13.9c2.2 3.8 7.1 5.1 10.9 2.9l28-16.1V312c0 4.4 3.6 8 8 8h16c4.4 0 8-3.6 8-8v-28.4l28 16.1c3.8 2.2 8.7.9 10.9-2.9l8-13.9c2.2-3.8.9-8.7-2.9-10.9l-27.9-16zM445.9 145.7l-15.5-26.8c-4.3-7.4-13.7-9.9-21.1-5.7l-33.8 19.5 7-26c2.2-8.2-2.7-16.7-10.9-18.9l-14.9-4c-8.2-2.2-16.7 2.7-18.9 10.9l-19 70.8-62.8 36.3v-77.5l53.7-53.7c6.2-6.2 6.2-16.4 0-22.6l-11.3-11.3c-6.2-6.2-16.4-6.2-22.6 0L256 56.4V16c0-8.8-7.2-16-16-16h-32c-8.8 0-16 7.2-16 16v40.4l-19.7-19.7c-6.2-6.2-16.4-6.2-22.6 0L138.3 48c-6.2 6.2-6.2 16.4 0 22.6l53.7 53.7v77.5l-62.8-36.2-19-70.8c-2.2-8.2-10.7-13.1-18.9-10.9l-14.9 4c-8.2 2.2-13.1 10.7-10.9 18.9l7 26-33.8-19.5c-7.4-4.3-16.8-1.7-21.1 5.7L2.1 145.7c-4.3 7.4-1.7 16.8 5.7 21.1l33.8 19.5-26 7c-8.3 2.2-13.2 10.7-11 19l4 14.9c2.2 8.2 10.7 13.1 18.9 10.9l70.8-19 63.8 36.9-63.8 36.9-70.8-19c-8.2-2.2-16.7 2.7-18.9 10.9l-4 14.9c-2.2 8.2 2.7 16.7 10.9 18.9l26 7-33.8 19.6c-7.4 4.3-9.9 13.7-5.7 21.1l15.5 26.8c4.3 7.4 13.7 9.9 21.1 5.7l33.8-19.5-7 26c-2.2 8.2 2.7 16.7 10.9 18.9l14.9 4c8.2 2.2 16.7-2.7 18.9-10.9l19-70.8 62.8-36.2v77.5l-53.7 53.7c-6.2 6.2-6.2 16.4 0 22.6l11.3 11.3c6.2 6.2 16.4 6.2 22.6 0l19.7-19.7V496c0 8.8 7.2 16 16 16h32c8.8 0 16-7.2 16-16v-40.4l19.7 19.7c6.2 6.2 16.4 6.2 22.6 0l11.3-11.3c6.2-6.2 6.2-16.4 0-22.6L256 387.7v-77.5l62.8 36.2 19 70.8c2.2 8.2 10.7 13.1 18.9 10.9l14.9-4c8.2-2.2 13.1-10.7 10.9-18.9l-7-26 33.8 19.5c7.4 4.3 16.8 1.7 21.1-5.7l15.5-26.8c4.3-7.4 1.7-16.8-5.7-21.1l-33.8-19.5 26-7c8.2-2.2 13.1-10.7 10.9-18.9l-4-14.9c-2.2-8.2-10.7-13.1-18.9-10.9l-70.8 19-63.8-36.9 63.8-36.9 70.8 19c8.2 2.2 16.7-2.7 18.9-10.9l4-14.9c2.2-8.2-2.7-16.7-10.9-18.9l-26-7 33.8-19.5c7.5-4.3 10-13.8 5.7-21.2zm82-25.7c0 4.4 3.6 8 8 8h16c4.4 0 8-3.6 8-8V91.6l28 16.1c3.8 2.2 8.7.9 10.9-2.9l8-13.9c2.2-3.8.9-8.7-2.9-10.9L576 64l27.9-16c3.8-2.2 5.1-7.1 2.9-10.9l-8-13.9c-2.2-3.8-7.1-5.1-10.9-2.9l-28 16.1V8c0-4.4-3.6-8-8-8h-16c-4.4 0-8 3.6-8 8v28.4l-28-16.1c-3.8-2.2-8.7-.9-10.9 2.9l-8 13.9c-2.2 3.8-.9 8.7 2.9 10.9l27.9 16-27.9 16c-3.8 2.2-5.1 7.1-2.9 10.9l8 13.9c2.2 3.8 7.1 5.1 10.9 2.9l28-16.1V120z" fill="currentColor"/>' },
      swamp: { viewBox: '0 0 576 512', path: '<path d="M446.53 97.43C439.67 60.23 407.19 32 368 32c-39.23 0-71.72 28.29-78.54 65.54C126.75 112.96-.5 250.12 0 416.98.11 451.9 29.08 480 64 480h304c8.84 0 16-7.16 16-16 0-17.67-14.33-32-32-32h-79.49l35.8-48.33c24.14-36.23 10.35-88.28-33.71-106.6-23.89-9.93-51.55-4.65-72.24 10.88l-32.76 24.59c-7.06 5.31-17.09 3.91-22.41-3.19-5.3-7.08-3.88-17.11 3.19-22.41l34.78-26.09c36.84-27.66 88.28-27.62 125.13 0 10.87 8.15 45.87 39.06 40.8 93.21L469.62 480H560c8.84 0 16-7.16 16-16 0-17.67-14.33-32-32-32h-53.63l-98.52-104.68 154.44-86.65A58.16 58.16 0 0 0 576 189.94c0-21.4-11.72-40.95-30.48-51.23-40.56-22.22-98.99-41.28-98.99-41.28zM368 136c-13.26 0-24-10.75-24-24 0-13.26 10.74-24 24-24 13.25 0 24 10.74 24 24 0 13.25-10.75 24-24 24z" fill="currentColor"/>' },
      mountains: { viewBox: '0 0 640 512', path: '<path d="M635.73 406.91l-194.04-297.6c-11.57-17.75-39.8-17.75-51.37 0l-32.84 50.37 67.68 105.68c2.38 3.72 1.3 8.67-2.42 11.05l-13.46 8.62c-3.72 2.38-8.67 1.3-11.05-2.42l-59.9-93.54-70.81-110.55c-12.4-19.36-42.64-19.36-55.04 0L4.58 403.18C-7.99 422.81 6.81 448 30.92 448h580.22c22.5 0 36.32-23.09 24.59-41.09z" fill="currentColor"/>' },
      plains: { viewBox: '0 0 512 512', path: '<path d="M64 96H0c0 123.7 100.3 224 224 224v144c0 8.8 7.2 16 16 16h32c8.8 0 16-7.2 16-16V320C288 196.3 187.7 96 64 96zm384-64c-84.2 0-157.4 46.5-195.7 115.2 27.7 30.2 48.2 66.9 59 107.6C424 243.1 512 147.9 512 32h-64z" fill="currentColor"/>' },
      coast: { viewBox: '0 0 77 82', path: '<path d="M76.0352 20.0736C72.7891 14.1752 64.8122 13.2572 61.5042 21.0072C59.2737 26.2377 63.68 34.7372 56.5237 34.0932C48.3675 33.3589 52.8675 21.2022 52.6253 15.9722C52.4261 11.9839 50.8128 8.19883 48.0784 5.29223C45.344 2.38563 41.6643 0.546131 37.6994 0.104731C33.7306 -0.340579 29.7385 0.643792 26.4294 2.87423C16.1404 10.214 19.1716 22.5302 23.9567 27.8742C25.0231 29.0656 26.6715 30.4914 26.6247 32.5617C26.5817 34.5656 25.1091 38.6867 20.3435 36.1437C17.2341 34.4835 17.0544 31.6789 14.4607 29.5265C8.9998 24.9992 1.9017 27.4249 0.0507039 34.5617H0.0467976C-0.105542 35.1828 0.121017 35.839 0.624918 36.2336C1.12883 36.6321 1.81632 36.6985 2.38662 36.4055C4.41392 35.3625 5.82022 34.0696 7.35142 34.2571C8.83192 34.4368 9.26552 35.7454 11.2264 38.4876C13.1522 41.1829 14.5545 43.261 17.8983 44.2806C7.63632 47.7767 2.05432 48.1712 1.75332 56.7146C1.46816 60.1716 3.01892 63.5271 5.84312 65.5427C6.38218 65.8943 7.08142 65.8982 7.62432 65.5505C8.16729 65.2029 8.45635 64.5661 8.3626 63.9294C7.91338 61.0856 7.96026 57.7497 9.24151 56.3903C10.3509 55.2184 11.8743 54.6481 15.8977 53.9176C19.9602 53.1754 23.3625 53.3356 27.1437 48.7731C22.9523 57.1872 16.8237 60.7531 16.4837 67.1011C16.0189 75.73 23.7142 83.4721 30.5107 78.1751V78.1712C30.9287 77.8626 31.1005 77.3235 30.9443 76.8274C30.788 76.3313 30.331 75.9876 29.8115 75.9797C28.8623 75.9993 27.917 75.8352 27.0303 75.4993C22.4405 73.4485 23.5576 67.9798 28.0537 63.3433C32.5381 58.7183 36.8349 58.1089 38.0146 49.8203C39.7373 63.9293 34.2568 68.4723 41.3818 76.5313L41.3857 76.5235C43.6904 79.0704 46.8232 80.7149 50.2295 81.1719C50.9365 81.2773 51.6397 80.9258 51.9834 80.2969C52.3272 79.668 52.2412 78.8907 51.7686 78.3477C48.8038 75.1211 47.0186 70.9844 46.7061 66.6137C46.6709 62.0707 50.2647 58.9067 48.1709 49.0357C51.8623 51.8677 59.7409 59.6407 58.9599 64.2697H58.9638C58.495 66.7424 56.8583 68.84 54.5693 69.8947C54.2138 70.0548 53.9755 70.3947 53.9482 70.7853C53.9208 71.1759 54.1083 71.547 54.4365 71.7579C56.0693 72.9259 58.1045 73.3946 60.0849 73.0587C67.4208 71.4767 72.9949 54.3047 56.2763 43.0787C62.0107 45.3756 68.7763 41.4068 69.7533 32.7737C70.097 29.7229 67.1674 23.9846 69.8001 21.5937C70.7533 20.7305 72.5228 21.1133 74.2571 21.918H74.261C74.7845 22.168 75.4094 22.0547 75.8118 21.6328C76.2142 21.2148 76.3047 20.5853 76.0352 20.0736ZM31.8322 26.8002C30.883 26.8002 30.0314 26.2299 29.6681 25.3549C29.3048 24.4799 29.504 23.4682 30.1759 22.8002C30.8439 22.1284 31.8556 21.9292 32.7306 22.2924C33.6056 22.6557 34.1759 23.5072 34.1759 24.4565C34.1759 25.7495 33.1252 26.8002 31.8322 26.8002ZM43.7462 24.9135C42.797 24.9135 41.9454 24.3432 41.5821 23.4643C41.2188 22.5893 41.418 21.5815 42.0899 20.9135C42.7579 20.2417 43.7696 20.0425 44.6446 20.4018C45.5196 20.7651 46.0899 21.6206 46.0899 22.5698C46.0899 23.1909 45.8438 23.7886 45.4024 24.226C44.9649 24.6674 44.3672 24.9135 43.7462 24.9135Z" fill="currentColor"/>' },
      jungle: { viewBox: '0 0 640 512', path: '<path d="M448.76 64c-39.43 0-75.06 11.74-103 30.5C327.14 40.17 265.37 0 191.24 0c-80.62 0-147.37 47.24-159 108.86C30.39 118.79 38.75 128 50 128h54l24-48 33.46 66.92c-3.53 3.07-7.28 5.69-10.66 9.07C93.8 213 80 293.6 115.37 345.38c5.7 8.34 18.12 8.94 26.07 1l146.13-146.14c10.72 104.75-11.42 215-25.85 272.15C256.64 492.52 272 512 292.8 512h55.13c15.75 0 29.67-11.37 31.71-27 14.79-113.47-11.57-236.34-26.41-293H488l24-48 24 48h54c11.25 0 19.61-9.21 17.74-19.14C596.13 111.24 529.38 64 448.76 64z" fill="currentColor"/>' },
      volcanic: { viewBox: '0 0 384 512', path: '<path d="M216 23.86c0-23.8-30.65-32.77-44.15-13.04C48 191.85 224 200 224 288c0 35.63-29.11 64.46-64.85 63.99-35.17-.45-63.15-29.77-63.15-64.94v-85.51c0-21.7-26.47-32.23-41.43-16.5C27.8 213.16 0 261.33 0 320c0 105.87 86.13 192 192 192s192-86.13 192-192c0-170.29-168-193-168-296.14z" fill="currentColor"/>' },
      arctic: { viewBox: '0 0 512 512', path: '<path d="M511.4 37.9C515.1 18.2 500 0 480 0H32C10.6 0-4.8 20.7 1.4 41.2l87.1 273.4c2.5 7.2 12.7 7.2 15.1 0L140 190.5l44.2 187.3c1.9 8.3 13.7 8.3 15.6 0l46.5-196.9 34.1 133.4c2.3 7.6 13 7.6 15.3 0l45.8-172.5 66.7 363.8c1.7 8.6 14 8.6 15.7 0l87.5-467.7z" fill="currentColor"/>' },
      savanna: { viewBox: '0 0 640 512', path: '<path d="M512 32c-13.16 0-25.52 2.66-37.4 6.4C464.71 15.82 442.23 0 416 0c-35.35 0-64 28.65-64 64 0 23.63 12.95 44.04 32 55.12V160c0 17.67 14.33 32 32 32h8c4.42 0 8 3.58 8 8v16c0 4.42-3.58 8-8 8h-8c-35.29 0-64-28.71-64-64v-24.8c-20.08-18.03-32-43.92-32-71.2 0-11.28 2.31-21.94 5.9-32H192C85.96 32 0 117.96 0 224v112c0 8.84 7.16 16 16 16h16v144c0 8.84 7.16 16 16 16h64c8.84 0 16-7.16 16-16V388.15C160.35 405.7 198.72 416 240 416s79.65-10.3 112-27.85V496c0 8.84 7.16 16 16 16h64c8.84 0 16-7.16 16-16V288h64c23.44 0 45.11-6.76 64-17.75V368c0 8.83-7.17 16-16 16s-16-7.17-16-16c0-8.84-7.16-16-16-16h-32c-8.84 0-16 7.16-16 16 0 46.87 40.52 84.46 88.36 79.57 41.62-4.25 71.64-42.46 71.64-84.3V160c0-70.69-57.31-128-128-128zm16 128c-8.84 0-16-7.16-16-16s7.16-16 16-16 16 7.16 16 16-7.16 16-16 16z" fill="currentColor"/>' },
      cavern: { viewBox: '0 0 640 512', path: '<path d="M558.44 129.7c-7.64-17.82-29.25-24.81-45.88-14.83L411.83 175.3 384 64l-42.67 32h-42.67L256 64l-27.83 111.3-100.74-60.44c-16.63-9.98-38.24-2.99-45.88 14.83L0 320l49.62-16.54c27.38-9.13 57.48 1.2 73.49 25.21L160 384l11.82-11.82c27.54-27.54 73.09-24.3 96.46 6.85L320 448l51.72-68.97c23.37-31.16 68.91-34.39 96.46-6.85L480 384l36.88-55.33c16.01-24.01 46.11-34.34 73.49-25.21L640 320l-81.56-190.3z" fill="currentColor"/>' },
    };

    const BIOME_TEMPS = {
      forest: 'mild', desert: 'hot', tundra: 'cold', swamp: 'warm', mountains: 'cool',
      plains: 'mild', coast: 'mild', jungle: 'hot', volcanic: 'scorching',
      arctic: 'freezing', savanna: 'hot', cavern: 'cool'
    };

    const WIND_LEVELS = {
      clear: 'Calm', cloudy: 'Light breeze', rain: 'Gusty', fog: 'Still',
      storm: 'Strong winds', windy: 'Howling winds', hot: 'Calm',
      sandstorm: 'Violent gusts', snow: 'Light breeze', blizzard: 'Gale force',
      foggy: 'Still', humid: 'Stagnant', downpour: 'Heavy gusts', misty: 'Gentle',
      ash: 'Swirling', smoke: 'Light drift', fiery: 'Intense drafts',
      ice_storm: 'Biting winds', dry: 'Calm', dust: 'Breezy',
      damp: 'Stagnant', dripping: 'Still'
    };

    let currentBiome = 'forest';
    let currentWeather = 'clear';
    let currentTime = 'morning';
    let particleSystem = null;
    let stormInterval = null;

    // Particle system with SCALE multiplier applied to all dimensions
    class WeatherParticles {
      constructor(container) {
        this.container = container;
        this.running = false;
        this.type = 'none';
        this.spawnInterval = null;
      }

      setType(type) {
        this.type = type;
        this.container.innerHTML = '';
        if (this.spawnInterval) {
          clearInterval(this.spawnInterval);
          this.spawnInterval = null;
        }
        if (this.running && type !== 'none') {
          this.startSpawning();
        }
      }

      start() {
        this.running = true;
        if (this.type !== 'none') {
          this.startSpawning();
        }
      }

      stop() {
        this.running = false;
        if (this.spawnInterval) {
          clearInterval(this.spawnInterval);
          this.spawnInterval = null;
        }
      }

      startSpawning() {
        // Same rates as original - spawn timing doesn't need scaling
        const rates = {
          rain: 40, storm: 25, downpour: 15,
          snow: 80, blizzard: 35,
          fog: 80, mist: 200,
          sand: 35, dust: 50,
          ash: 100, smoke: 120, sparks: 120,
          rays: 150, clouds: 400,
          wind: 50, heat: 200, ice: 40, drip: 300
        };

        const rate = rates[this.type] || 100;
        this.spawnInterval = setInterval(() => {
          if (this.running) this.createParticle();
        }, rate);
      }

      createParticle() {
        const particle = document.createElement('div');
        particle.className = 'particle';

        // Original widget dimensions
        const origW = 329;
        const origH = 155;

        switch (this.type) {
          case 'rain':
          case 'storm':
          case 'downpour':
            if (Math.random() < 0.85) {
              particle.classList.add('rain');
              const rainIntensity = this.type === 'downpour' ? 1.8 : this.type === 'storm' ? 1.4 : 1;
              const windAngle = this.type === 'storm' ? 20 + Math.random() * 10 : 12 + Math.random() * 6;
              const totalFall = HEIGHT + 30 * SCALE;
              const rainDrift = Math.tan(windAngle * Math.PI / 180) * totalFall;
              particle.style.left = Math.random() * WIDTH + 'px';
              particle.style.top = (-15 * SCALE) + 'px';
              // Original: (18 + Math.random() * 14) * rainIntensity
              particle.style.height = ((18 + Math.random() * 14) * rainIntensity * SCALE) + 'px';
              particle.style.transform = `rotate(${-windAngle}deg)`;
              particle.style.opacity = 0.6 + Math.random() * 0.3;
              // Scale duration proportionally
              const speed = (this.type === 'downpour' ? 250 : this.type === 'storm' ? 300 : 400) * SCALE;
              particle.animate([
                { transform: `translate(0, 0) rotate(${-windAngle}deg)`, opacity: 0.7 },
                { transform: `translate(${rainDrift}px, ${totalFall}px) rotate(${-windAngle}deg)`, opacity: 0.35 }
              ], { duration: speed + Math.random() * 150 * SCALE, easing: 'linear' }).onfinish = () => particle.remove();
            } else {
              particle.classList.add('splash');
              particle.style.width = (4 * SCALE) + 'px';
              particle.style.height = (2 * SCALE) + 'px';
              particle.style.left = Math.random() * WIDTH + 'px';
              particle.style.top = (HEIGHT - 15 * SCALE + Math.random() * 10 * SCALE) + 'px';
              particle.animate([
                { transform: 'scale(0) translateY(0)', opacity: 0.7 },
                { transform: `scale(1.5) translateY(${-3 * SCALE}px)`, opacity: 0.5, offset: 0.3 },
                { transform: `scale(2) translateY(${-1 * SCALE}px)`, opacity: 0 }
              ], { duration: (300 + Math.random() * 100) * SCALE, easing: 'ease-out' }).onfinish = () => particle.remove();
            }
            break;

          case 'snow':
          case 'blizzard':
            particle.classList.add('snowflake');
            // Original: blizzard 4-9px, snow 3-7px
            const snowSize = (this.type === 'blizzard' ? 4 + Math.random() * 5 : 3 + Math.random() * 4) * SCALE;
            particle.style.width = snowSize + 'px';
            particle.style.height = snowSize + 'px';
            particle.style.left = Math.random() * WIDTH + 'px';
            particle.style.top = (-10 * SCALE) + 'px';
            // Original: blizzard 120-300px drift, snow 30-80px
            const drift = (this.type === 'blizzard' ? 120 + Math.random() * 180 : 30 + Math.random() * 50) * SCALE;
            const dur = this.type === 'blizzard' ? 800 + Math.random() * 400 : 2500 + Math.random() * 1500;
            const wobble1 = (Math.random() - 0.5) * 20 * SCALE;
            const wobble2 = (Math.random() - 0.5) * 25 * SCALE;
            particle.animate([
              { transform: 'translate(0, 0) rotate(0deg)', opacity: 0 },
              { transform: `translate(${drift * 0.2 + wobble1}px, ${HEIGHT * 0.25}px) rotate(90deg)`, opacity: 0.9, offset: 0.25 },
              { transform: `translate(${drift * 0.5 + wobble2}px, ${HEIGHT * 0.5}px) rotate(180deg)`, opacity: 0.85, offset: 0.5 },
              { transform: `translate(${drift * 0.8 + wobble1}px, ${HEIGHT * 0.75}px) rotate(270deg)`, opacity: 0.7, offset: 0.75 },
              { transform: `translate(${drift}px, ${HEIGHT + 20 * SCALE}px) rotate(360deg)`, opacity: 0.3 }
            ], { duration: dur * SCALE, easing: 'ease-in-out' }).onfinish = () => particle.remove();
            break;

          case 'fog':
          case 'mist':
            if (Math.random() < 0.8) {
              particle.classList.add('fog');
              // Original: 40-120px width, 1-3px height
              const fogWidth = (40 + Math.random() * 80) * SCALE;
              particle.style.width = fogWidth + 'px';
              particle.style.height = ((1 + Math.random() * 2) * SCALE) + 'px';
              particle.style.left = '-' + fogWidth + 'px';
              particle.style.top = Math.random() * HEIGHT + 'px';
              const peakOpacity = this.type === 'fog' ? 0.15 : 0.1;
              const yDrift = (Math.random() - 0.5) * 30 * SCALE;
              particle.animate([
                { transform: 'translateX(0) translateY(0) scaleY(1)', opacity: 0 },
                { transform: `translateX(${WIDTH * 0.3}px) translateY(${yDrift * 0.3}px) scaleY(1.2)`, opacity: peakOpacity, offset: 0.3 },
                { transform: `translateX(${WIDTH * 0.6}px) translateY(${yDrift * 0.7}px) scaleY(0.9)`, opacity: peakOpacity * 0.8, offset: 0.6 },
                { transform: `translateX(${WIDTH + fogWidth + 50 * SCALE}px) translateY(${yDrift}px) scaleY(1)`, opacity: 0 }
              ], { duration: (12000 + Math.random() * 8000) * SCALE, easing: 'ease-in-out' }).onfinish = () => particle.remove();
            } else {
              particle.classList.add('fogbank');
              // Original: 80-200px width, 25-60px height
              const bankWidth = (80 + Math.random() * 120) * SCALE;
              const bankHeight = (25 + Math.random() * 35) * SCALE;
              particle.style.width = bankWidth + 'px';
              particle.style.height = bankHeight + 'px';
              particle.style.left = '-' + bankWidth + 'px';
              particle.style.top = (Math.random() * (HEIGHT - bankHeight)) + 'px';
              const peakOpacity = this.type === 'fog' ? 0.2 : 0.12;
              particle.animate([
                { transform: 'translateX(0) scale(0.8)', opacity: 0 },
                { transform: `translateX(${WIDTH * 0.4}px) scale(1.1)`, opacity: peakOpacity, offset: 0.4 },
                { transform: `translateX(${WIDTH + bankWidth + 30 * SCALE}px) scale(0.9)`, opacity: 0 }
              ], { duration: (18000 + Math.random() * 10000) * SCALE, easing: 'ease-in-out' }).onfinish = () => particle.remove();
            }
            break;

          case 'sand':
          case 'dust':
            particle.classList.add('sand');
            // Original: sand 2-5px, dust 1.5-3.5px
            const sandSize = (this.type === 'sand' ? 2 + Math.random() * 3 : 1.5 + Math.random() * 2) * SCALE;
            particle.style.width = sandSize + 'px';
            particle.style.height = (sandSize * 0.6) + 'px';
            particle.style.left = (-10 * SCALE) + 'px';
            particle.style.top = Math.random() * HEIGHT + 'px';
            const sandSpeed = (this.type === 'sand' ? 500 : 800) * SCALE;
            const yWave1 = (Math.random() - 0.5) * 15 * SCALE;
            const yWave2 = (Math.random() - 0.5) * 20 * SCALE;
            const yWave3 = (Math.random() - 0.5) * 15 * SCALE;
            particle.animate([
              { transform: 'translate(0, 0) rotate(0deg)', opacity: 0 },
              { transform: `translate(${WIDTH * 0.25}px, ${yWave1}px) rotate(180deg)`, opacity: 0.75, offset: 0.25 },
              { transform: `translate(${WIDTH * 0.5}px, ${yWave2}px) rotate(360deg)`, opacity: 0.7, offset: 0.5 },
              { transform: `translate(${WIDTH * 0.75}px, ${yWave3}px) rotate(540deg)`, opacity: 0.5, offset: 0.75 },
              { transform: `translate(${WIDTH + 30 * SCALE}px, ${(Math.random() - 0.5) * 25 * SCALE}px) rotate(720deg)`, opacity: 0 }
            ], { duration: sandSpeed + Math.random() * 300 * SCALE, easing: 'ease-in-out' }).onfinish = () => particle.remove();
            break;

          case 'ash':
          case 'smoke':
            particle.classList.add('ash');
            // Original: 3px size (from CSS)
            const ashSize = 3 * SCALE;
            particle.style.width = ashSize + 'px';
            particle.style.height = ashSize + 'px';
            particle.style.left = Math.random() * WIDTH + 'px';
            particle.style.top = (HEIGHT + 10 * SCALE) + 'px';
            const driftX = (Math.random() - 0.5) * 60 * SCALE;
            particle.animate([
              { transform: 'translate(0, 0)', opacity: 0 },
              { transform: `translate(${driftX * 0.3}px, -${HEIGHT * 0.3}px)`, opacity: 0.6, offset: 0.3 },
              { transform: `translate(${driftX}px, -${HEIGHT + 30 * SCALE}px)`, opacity: 0 }
            ], { duration: (3000 + Math.random() * 2000) * SCALE, easing: 'ease-out' }).onfinish = () => particle.remove();
            break;

          case 'sparks':
            if (Math.random() < 0.6) {
              particle.classList.add('ember');
              // Original: 3-7px
              const emberSize = (3 + Math.random() * 4) * SCALE;
              particle.style.width = emberSize + 'px';
              particle.style.height = emberSize + 'px';
              particle.style.left = Math.random() * WIDTH + 'px';
              particle.style.top = (HEIGHT + 5 * SCALE) + 'px';
              const emberDriftX = (Math.random() - 0.5) * 100 * SCALE;
              const wobbleX = (Math.random() - 0.5) * 30 * SCALE;
              particle.animate([
                { transform: 'translate(0, 0) scale(0.5)', opacity: 0 },
                { transform: `translate(${emberDriftX * 0.3 + wobbleX}px, -${HEIGHT * 0.3}px) scale(1)`, opacity: 1, offset: 0.2 },
                { transform: `translate(${emberDriftX * 0.6 - wobbleX}px, -${HEIGHT * 0.6}px) scale(0.9)`, opacity: 0.9, offset: 0.5 },
                { transform: `translate(${emberDriftX * 0.8 + wobbleX}px, -${HEIGHT * 0.85}px) scale(0.6)`, opacity: 0.6, offset: 0.8 },
                { transform: `translate(${emberDriftX}px, -${HEIGHT + 30 * SCALE}px) scale(0.2)`, opacity: 0 }
              ], { duration: (2500 + Math.random() * 1500) * SCALE, easing: 'ease-out' }).onfinish = () => particle.remove();
            } else {
              particle.classList.add('spark');
              // Original: 2px (from CSS)
              const sparkSize = 2 * SCALE;
              particle.style.width = sparkSize + 'px';
              particle.style.height = sparkSize + 'px';
              particle.style.left = Math.random() * WIDTH + 'px';
              particle.style.top = (HEIGHT + 5 * SCALE) + 'px';
              const sparkDriftX = (Math.random() - 0.5) * 60 * SCALE;
              particle.animate([
                { transform: 'translate(0, 0) scale(1)', opacity: 0.9 },
                { transform: `translate(${sparkDriftX * 0.4}px, -${HEIGHT * 0.4}px) scale(0.7)`, opacity: 1, offset: 0.4 },
                { transform: `translate(${sparkDriftX}px, -${HEIGHT + 10 * SCALE}px) scale(0.2)`, opacity: 0 }
              ], { duration: (1000 + Math.random() * 600) * SCALE, easing: 'ease-out' }).onfinish = () => particle.remove();
            }
            break;

          case 'rays':
            const isNightTime = currentTime === 'evening' || currentTime === 'night';
            if (isNightTime) {
              particle.classList.add('star');
              // Original: 0.5-1.5px
              const starSize = (0.5 + Math.random() * 1) * SCALE;
              particle.style.width = starSize + 'px';
              particle.style.height = starSize + 'px';
              particle.style.left = (Math.random() * WIDTH) + 'px';
              particle.style.top = (5 * SCALE + Math.random() * HEIGHT * 0.35) + 'px';
              const twinkleDuration = 4000 + Math.random() * 4000;
              const maxOpacity = 0.4 + Math.random() * 0.5;
              particle.animate([
                { opacity: 0, transform: 'scale(0.8)' },
                { opacity: maxOpacity, transform: 'scale(1)', offset: 0.4 },
                { opacity: maxOpacity * 0.7, transform: 'scale(0.95)', offset: 0.6 },
                { opacity: maxOpacity, transform: 'scale(1)', offset: 0.8 },
                { opacity: 0, transform: 'scale(0.8)' }
              ], { duration: twinkleDuration * SCALE, easing: 'ease-in-out' }).onfinish = () => particle.remove();
            } else {
              const rand = Math.random();
              if (rand < 0.15) {
                particle.classList.add('sundust');
                // Original: 1-2.5px
                const dustSize = (1 + Math.random() * 1.5) * SCALE;
                particle.style.width = dustSize + 'px';
                particle.style.height = dustSize + 'px';
                const dustX = 30 * SCALE + Math.random() * (WIDTH - 60 * SCALE);
                const dustY = 20 * SCALE + Math.random() * (HEIGHT - 50 * SCALE);
                particle.style.left = dustX + 'px';
                particle.style.top = dustY + 'px';
                const driftXDust = (Math.random() - 0.5) * 15 * SCALE;
                const driftYDust = (-5 - Math.random() * 10) * SCALE;
                particle.animate([
                  { transform: 'translate(0, 0)', opacity: 0 },
                  { transform: `translate(${driftXDust * 0.5}px, ${driftYDust * 0.5}px)`, opacity: 0.4, offset: 0.4 },
                  { transform: `translate(${driftXDust}px, ${driftYDust}px)`, opacity: 0 }
                ], { duration: (4000 + Math.random() * 2000) * SCALE, easing: 'ease-in-out' }).onfinish = () => particle.remove();
              } else {
                particle.classList.add('ray');
                // Original: 8-23px width, 100-160px height
                const rayWidth = (8 + Math.random() * 15) * SCALE;
                const rayHeight = (100 + Math.random() * 60) * SCALE;
                particle.style.width = rayWidth + 'px';
                particle.style.height = rayHeight + 'px';
                particle.style.left = Math.random() * WIDTH + 'px';
                particle.style.top = (-20 * SCALE) + 'px';
                const angle = 5 + Math.random() * 15;
                particle.style.transform = `rotate(${angle}deg)`;
                particle.animate([
                  { opacity: 0, transform: `rotate(${angle}deg) scaleY(0.7)` },
                  { opacity: 0.5, transform: `rotate(${angle}deg) scaleY(1)`, offset: 0.3 },
                  { opacity: 0.4, transform: `rotate(${angle}deg) scaleY(1)`, offset: 0.7 },
                  { opacity: 0, transform: `rotate(${angle}deg) scaleY(0.8)` }
                ], { duration: (3500 + Math.random() * 2000) * SCALE, easing: 'ease-in-out' }).onfinish = () => particle.remove();
              }
            }
            break;

          case 'clouds':
            particle.classList.add('cloud');
            // Original: 100-250px width, 50-120px height
            const cloudWidth = (100 + Math.random() * 150) * SCALE;
            const cloudHeight = (50 + Math.random() * 70) * SCALE;
            particle.style.width = cloudWidth + 'px';
            particle.style.height = cloudHeight + 'px';
            particle.style.left = -cloudWidth + 'px';
            particle.style.top = (Math.random() * HEIGHT * 0.7) + 'px';
            particle.animate([
              { transform: 'translateX(0)', opacity: 0 },
              { transform: `translateX(${WIDTH * 0.15}px)`, opacity: 0.5, offset: 0.1 },
              { transform: `translateX(${WIDTH * 0.85}px)`, opacity: 0.5, offset: 0.9 },
              { transform: `translateX(${WIDTH + cloudWidth + 50 * SCALE}px)`, opacity: 0 }
            ], { duration: (20000 + Math.random() * 15000) * SCALE, easing: 'linear' }).onfinish = () => particle.remove();
            break;

          case 'wind':
            // Original: 30-70px width, 1px height
            particle.style.width = ((30 + Math.random() * 40) * SCALE) + 'px';
            particle.style.height = (1 * SCALE) + 'px';
            particle.style.background = 'linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent)';
            particle.style.left = (-50 * SCALE) + 'px';
            particle.style.top = Math.random() * HEIGHT + 'px';
            particle.animate([
              { transform: 'translateX(0)', opacity: 0 },
              { transform: `translateX(${100 * SCALE}px)`, opacity: 0.4, offset: 0.3 },
              { transform: `translateX(${WIDTH + 100 * SCALE}px)`, opacity: 0 }
            ], { duration: (800 + Math.random() * 400) * SCALE, easing: 'linear' }).onfinish = () => particle.remove();
            break;

          case 'heat':
            // Original: 40px width, 2px height
            particle.style.width = (40 * SCALE) + 'px';
            particle.style.height = (2 * SCALE) + 'px';
            particle.style.background = 'linear-gradient(90deg, transparent, rgba(255,200,100,0.2), transparent)';
            particle.style.left = Math.random() * WIDTH + 'px';
            particle.style.top = HEIGHT + 'px';
            particle.animate([
              { transform: 'translateY(0) scaleX(1)', opacity: 0 },
              { transform: `translateY(${-30 * SCALE}px) scaleX(1.2)`, opacity: 0.3, offset: 0.5 },
              { transform: `translateY(${-60 * SCALE}px) scaleX(0.8)`, opacity: 0 }
            ], { duration: (2000 + Math.random() * 1000) * SCALE, easing: 'ease-out' }).onfinish = () => particle.remove();
            break;

          case 'ice':
            particle.classList.add('snow');
            // Original: 3px width, 8px height
            particle.style.width = (3 * SCALE) + 'px';
            particle.style.height = (8 * SCALE) + 'px';
            particle.style.borderRadius = (1 * SCALE) + 'px';
            particle.style.left = Math.random() * WIDTH + 'px';
            particle.style.top = (-10 * SCALE) + 'px';
            particle.animate([
              { transform: 'translateY(0) rotate(30deg)', opacity: 0.8 },
              { transform: `translateY(${HEIGHT + 20 * SCALE}px) rotate(30deg)`, opacity: 0.4 }
            ], { duration: (500 + Math.random() * 200) * SCALE, easing: 'linear' }).onfinish = () => particle.remove();
            break;

          case 'drip':
            particle.classList.add('drip');
            // Original: 3px width, 6px height
            particle.style.width = (3 * SCALE) + 'px';
            particle.style.height = (6 * SCALE) + 'px';
            particle.style.left = Math.random() * WIDTH + 'px';
            particle.style.top = (-8 * SCALE) + 'px';
            particle.animate([
              { transform: 'translateY(0)', opacity: 0 },
              { transform: `translateY(${20 * SCALE}px)`, opacity: 0.6, offset: 0.3 },
              { transform: `translateY(${HEIGHT + 20 * SCALE}px)`, opacity: 0.3 }
            ], { duration: (1500 + Math.random() * 600) * SCALE, easing: 'ease-in' }).onfinish = () => particle.remove();
            break;
        }

        this.container.appendChild(particle);
      }
    }

    function triggerLightning() {
      const lightning = document.getElementById('lightning');
      lightning.classList.add('active');
      setTimeout(() => lightning.classList.remove('active'), 150);
    }

    function updatePreview() {
      const frame = document.getElementById('previewFrame');
      frame.className = `preview-frame biome-${currentBiome} time-${currentTime}`;

      const biomeIconData = BIOME_ICONS[currentBiome];
      const biomeIconEl = document.getElementById('biomeIcon');
      biomeIconEl.setAttribute('viewBox', biomeIconData.viewBox);
      biomeIconEl.innerHTML = biomeIconData.path;
      document.getElementById('biomeLabel').textContent = currentBiome.charAt(0).toUpperCase() + currentBiome.slice(1);

      document.getElementById('timeIcon').innerHTML = TIME_ICONS[currentTime];
      document.getElementById('timeLabel').textContent = currentTime.toUpperCase();

      const weatherInfo = WEATHER_INFO[currentWeather] || { name: currentWeather, detail: '', particles: 'none' };
      document.getElementById('weatherName').textContent = weatherInfo.name;
      document.getElementById('weatherDetail').textContent = weatherInfo.detail;

      document.getElementById('tempFeel').textContent = BIOME_TEMPS[currentBiome].charAt(0).toUpperCase() + BIOME_TEMPS[currentBiome].slice(1);
      document.getElementById('windSpeed').textContent = WIND_LEVELS[currentWeather] || 'Calm';

      // Update particles
      if (particleSystem) {
        if (weatherInfo.particles === 'rays') {
          particleSystem.setType('none');
          particleSystem.setType('rays');
        } else {
          particleSystem.setType(weatherInfo.particles);
        }
      }

      // Storm lightning
      if (stormInterval) {
        clearInterval(stormInterval);
        stormInterval = null;
      }
      if (currentWeather === 'storm' || currentWeather === 'ice_storm') {
        stormInterval = setInterval(() => {
          if (Math.random() < 0.3) triggerLightning();
        }, 2000);
      }
    }

    function populateWeatherOptions() {
      const select = document.getElementById('weatherSelect');
      const options = BIOME_WEATHER[currentBiome];
      select.innerHTML = '';
      options.forEach(w => {
        const opt = document.createElement('option');
        opt.value = w;
        opt.textContent = (WEATHER_INFO[w]?.name || w);
        select.appendChild(opt);
      });
      if (!options.includes(currentWeather)) {
        currentWeather = options[0];
      }
      select.value = currentWeather;
    }

    document.getElementById('biomeSelect').addEventListener('change', e => {
      currentBiome = e.target.value;
      populateWeatherOptions();
      updatePreview();
    });

    document.getElementById('weatherSelect').addEventListener('change', e => {
      currentWeather = e.target.value;
      updatePreview();
    });

    document.getElementById('timeSelect').addEventListener('change', e => {
      currentTime = e.target.value;
      updatePreview();
    });

    // Initialize
    particleSystem = new WeatherParticles(document.getElementById('particles'));
    particleSystem.start();
    populateWeatherOptions();
    updatePreview();
  </script>
</body>
</html>
